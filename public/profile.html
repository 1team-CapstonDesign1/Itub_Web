<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <title>I-Tub</title>
    <link rel="stylesheet" href="./css/swiper.min.css">
    <link rel="stylesheet" href="./css/profile_style.css">
</head>

<body bgcolor="#000000" text="#ffffff" link="000ff" vlink="808080">
    <div class="all-wrap">
        <button onclick=del_div() class="btn">
            <img src='./images/cancelBtn.png' width="100%" height="100%" class="cancel-img">
        </button>
        <div class="swiper-container">
            <div class="swiper-wrapper"></div>
                <div>
                <div class='swiper-slide'><img src='./images/plusBtn.png' width='60%' height='60%'></div>
            </div>

            <div class="swiper-pagination"></div>

        </div>
        <div class="side-wrap">
            <ul class="label-box">
                <li>
                    <div class="side-wrap-box">
                        <div class="label-title">
                            <h3>닉네임</h3>
                        </div>
                        <div class="label-context">
                            <label class="labeling" id='label_name'>사용자를 추가시켜 주세요</label>
                        </div>
                    </div>


                </li>
                <li>
                    <div class="side-wrap-box">
                        <div class="label-title">
                            <h3>성별</h3>
                        </div>
                        <div class="label-context">
                            <label class="labeling" id='label_gender'>사용자를 추가시켜 주세요</label>
                        </div>
                    </div>
                </li>

                <li>
                    <div class="side-wrap-box">
                        <div class="label-title">
                            <h3>나이</h3>
                        </div>
                        <div class="label-context">
                            <label class="labeling" id='label_age'>사용자를 추가시켜 주세요</label>
                        </div>
                    </div>
                </li>

                <li>
                    <div class="side-wrap-box">
                        <div class="label-title">
                            <h3>직업</h3>
                        </div>
                        <div class="label-context">
                            <label class="labeling" id='label_job'>사용자를 추가시켜 주세요</label>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <div class="home_button">
        <div class="button_margin">
            <a href="./main_page.html">
                <img src="./images/backBtn.png" style="float: right" width="50px">
            </a>
        </div>
        <div class="button_margin">
            <a href="./main_page.html">
                <img src="./images/homeBtn.png" style="float: left" width="50px">
            </a>
        </div>
    </div>

    <script src="./js/swiper.min.js"></script>

    <script>
        var tmp = '';
        var slideNum = 0;
        var previousNum = 0;

        var swiper = new Swiper('.swiper-container', {
            loop: false,

            pagination: {
                el: '.swiper-pagination',
                clickable: true,
                dynamicBullets: true,
            },

            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },

            on: {
                tap: function () {
                    if (swiper.activeIndex !== tmp.length) {
                        if (confirm('[' + tmp[swiper.activeIndex].u_name + '] 사용자로 시작하시겠어요?'), '사용자 선택'){
                            document.location.href = './user_choice.html'
                        }

                        else return false;
                    }

                    else document.location.href = './register.html';
                },

                slideChangeTransitionStart: function () {
                    if (swiper.activeIndex !== tmp.length) {
                        document.getElementById('label_name').innerHTML = tmp[swiper.activeIndex].u_name;
                        if (!tmp[swiper.activeIndex].u_gender) document.getElementById('label_gender').innerHTML = '남성';
                        else document.getElementById('label_gender').innerHTML = '여성';
                        document.getElementById('label_age').innerHTML = tmp[swiper.activeIndex].u_age;
                        document.getElementById('label_job').innerHTML = tmp[swiper.activeIndex].u_job;
                    }

                    else {
                        document.getElementById('label_name').innerHTML = '사용자를 추가시켜 주세요';
                        document.getElementById('label_gender').innerHTML = '사용자를 추가시켜 주세요';
                        document.getElementById('label_age').innerHTML = '사용자를 추가시켜 주세요';
                        document.getElementById('label_job').innerHTML = '사용자를 추가시켜 주세요';
                    }
                }
            }
        });


        function del_div() {
            if (tmp.length < 1) alert('지울 사용자가 없습니다.');
            else {
                alert(tmp[swiper.activeIndex].u_name + ' 사용자가 삭제되었습니다.');
                sendDB('/db/delete', tmp[swiper.activeIndex].u_num);
                window.location.reload(true);
            }
        }

        function add_div() {
            console.log(tmp);
            for (var i = 0; i < tmp.length; i++) {
                if (tmp[i].u_age < 15) {
                    if (tmp[i].u_gender == 0) path = './images/boy.png'
                    else path = './images/girl.png'
                } else if (tmp[i].u_age >= 15 && tmp[i].u_age <= 65) {
                    if (tmp[i].u_gender == 0) path = './images/fa.png'
                    else path = './images/ma.png'
                } else {
                    if (tmp[i].u_gender == 0) path = './images/granfa.png'
                    else path = './images/granma.png'
                }

                var htmlCode = '<div class="swiper-slide"><div class="vertical"><img src=' + path + ' class="imgtag"></div></div>';
                swiper.appendSlide(htmlCode);
                swiper.update();
            }

            swiper.appendSlide('<div class="swiper-slide"><div class="vertical"><img src="./images/plusBtn.png class="imgtag"></div></div>');
            document.getElementById('label_name').innerHTML = tmp[swiper.activeIndex].u_name;
            if (!tmp[swiper.activeIndex].u_gender) document.getElementById('label_gender').innerHTML = '남성';
            else document.getElementById('label_gender').innerHTML = '여성';
            document.getElementById('label_age').innerHTML = tmp[swiper.activeIndex].u_age;
            document.getElementById('label_job').innerHTML = tmp[swiper.activeIndex].u_job;
        }

        function sendDB(url, data) {
            var data = {
                'data': data
            };
            console.log(data + '데이터형 변경 전');
            data = JSON.stringify(data); // json을 문자열 형태로 만들어줌
            console.log(data + '데이터형 변경 후');
            var xhr = new XMLHttpRequest();
            xhr.open('POST', url);
            xhr.setRequestHeader('Content-Type', 'application/json');
            // 서버로 보낼때 json 형태의 데이터를 보내기위해 지정
            xhr.send(data); // 문자열 형태로 넣어줘야함
            console.log(data + 'xhr send')

            xhr.addEventListener('load', function () {
                var result = JSON.parse(xhr.responseText);
                var resultDiv;
                console.log('데이터 넘겨받음' + result.result)
                if (result.result == 'ok' && result.type == 'reference') {
                    tmp = result.DB;
                    add_div();
                    console.log('조회가 완료되었습니다.');
                } else if (result.result == 'ok' && result.type == 'delete') {
                    console.log('삭제가 완료되었습니다.');
                } else if (result.result == 'none' && result.type == 'reference') {
                    tmp = {'':''};
                    add_div();
                    console.log('되겠냐?');
                } else if (result.result == 'none' && result.type == 'delete') {
                    tmp = '';
                    console.log('되겠냐?');
                }
            });
        }

        window.onload = function () {
            sendDB('/db/reference', 'ok');
        };
    </script>


</body>

</html>